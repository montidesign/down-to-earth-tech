---
import Layout from '../../layouts/Layout.astro';
import Footer from '../../components/Footer.astro';
import VideoBackground from '../../components/VideoBackground.astro';
import BlogSidebar from '../../components/BlogSidebar.astro';
import PostMeta from '../../components/PostMeta.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
	const allPosts = await getCollection('posts', ({ data }) => !data.draft);

	// Get unique categories
	const categories = [...new Set(allPosts.map(post => post.data.categorySlug))];

	return categories.map(categorySlug => {
		const categoryPosts = allPosts
			.filter(post => post.data.categorySlug === categorySlug)
			.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

		const categoryName = categoryPosts[0]?.data.category || categorySlug;

		return {
			params: { slug: categorySlug },
			props: {
				categoryName,
				categorySlug,
				posts: categoryPosts,
			},
		};
	});
}

const { categoryName, categorySlug, posts } = Astro.props;

// Pagination settings
const postsPerPage = 6;
const totalPages = Math.ceil(posts.length / postsPerPage);
const currentPage = 1;
const paginatedPosts = posts.slice(0, postsPerPage);

const seoTitle = `${categoryName} - IT Articles & Resources | Down To Earth Technology`;
const seoDescription = `Browse our ${categoryName} articles and resources. Expert IT insights and tips from Down to Earth Technology in Waco, TX.`;

const pageSchema = [
  {
    "@type": "BreadcrumbList",
    "itemListElement": [
      { "@type": "ListItem", "position": 1, "item": { "@id": "https://downtoearthtech.net", "name": "Home" }},
      { "@type": "ListItem", "position": 2, "item": { "@id": "https://downtoearthtech.net/data-hub/", "name": "Data Hub" }},
      { "@type": "ListItem", "position": 3, "item": { "@id": `https://downtoearthtech.net/category/${categorySlug}/`, "name": categoryName }}
    ]
  },
  {
    "@type": "CollectionPage",
    "name": `${categoryName} Articles`,
    "description": seoDescription,
    "url": `https://downtoearthtech.net/category/${categorySlug}/`,
    "isPartOf": {
      "@type": "Blog",
      "name": "Down to Earth Technology Blog",
      "url": "https://downtoearthtech.net/data-hub/"
    }
  }
];
---

<VideoBackground />

<Layout
  title={seoTitle}
  description={seoDescription}
  canonical={`/category/${categorySlug}/`}
  schema={pageSchema}
>
	<section class="relative mt-[173px] py-12 bg-white/95">
		<div class="max-w-[1080px] mx-auto px-4">
			<div class="flex flex-col lg:flex-row gap-0">
				<!-- Main Content -->
				<main class="lg:w-[79%] lg:pr-[5.5%]">
					{paginatedPosts.length === 0 ? (
						<p class="text-center text-gray-600 text-xl font-cuprum py-12">
							No posts in this category yet.
						</p>
					) : (
						<div class="space-y-10">
							{paginatedPosts.map(post => (
								<article class="border-b border-gray-200 pb-10 last:border-0">
									{post.data.featuredImage && (
										<a href={`/${post.slug}/`} class="block mb-4">
											<img
												src={post.data.featuredImage}
												alt={post.data.featuredImageAlt || post.data.title}
												class="w-full h-64 object-cover rounded shadow-lg hover:opacity-90 transition-opacity"
												loading="lazy"
												decoding="async"
											/>
										</a>
									)}
									<h2 class="font-montserrat font-bold text-2xl text-[rgb(226,77,61)] mb-3 leading-tight">
										<a
											href={`/${post.slug}/`}
											class="hover:text-[rgb(180,60,45)] transition-colors"
										>
											{post.data.title}
										</a>
									</h2>
									<PostMeta
										author={post.data.author}
										pubDate={post.data.pubDate}
										category={post.data.category}
										categorySlug={post.data.categorySlug}
									/>
									{(post.data.excerpt || post.data.description) && (
										<p class="text-gray-700 text-lg font-cuprum leading-relaxed">
											{post.data.excerpt || post.data.description}
										</p>
									)}
								</article>
							))}
						</div>
					)}

					{/* Pagination */}
					{totalPages > 1 && (
						<nav class="flex justify-between items-center mt-10 pt-6 border-t border-gray-200">
							{currentPage < totalPages && (
								<a
									href={`/category/${categorySlug}/${currentPage + 1}/`}
									class="text-[rgb(49,100,138)] hover:text-[rgb(226,77,61)] font-cuprum text-lg transition-colors"
								>
									Â« Older Entries
								</a>
							)}
						</nav>
					)}
				</main>

				<!-- Sidebar with vertical divider -->
				<aside class="lg:w-[21%] lg:border-l lg:border-gray-200 lg:pl-[5.5%]">
					<BlogSidebar />
				</aside>
			</div>
		</div>
	</section>

	<Footer />
</Layout>
